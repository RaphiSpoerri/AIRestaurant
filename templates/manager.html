{% extends "base.html" %}
{% load tz %}

{% block title %}Manager Profile - {{ target.username }}{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-8">
    <div class="card mb-3">
      <div class="card-body">
        <h2>{{ target.username }}</h2>
        <p><strong>User type:</strong> Manager</p>
        {% if private_visible %}
          <p><strong>Admin access:</strong> Yes</p>
        {% endif %}
      </div>
    </div>

    {% if pending_users %}
    <div class="card mb-3">
      <div class="card-header">
        <h5 class="mb-0">Pending Registration Requests ({{ pending_users|length }})</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Type</th>
                <th>Requested</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for pending_user in pending_users %}
              <tr>
                <td><strong>{{ pending_user.username }}</strong></td>
                <td>{{ pending_user.email }}</td>
                <td>
                  <span class="badge bg-info">
                    {% if pending_user.type == 'CU' %}Customer
                    {% elif pending_user.type == 'CH' %}Chef
                    {% elif pending_user.type == 'DL' %}Deliverer
                    {% elif pending_user.type == 'MN' %}Manager
                    {% else %}{{ pending_user.type }}{% endif %}
                  </span>
                </td>
                <td><small>{{ pending_user.date_joined|date:"M d, Y H:i" }}</small></td>
                <td>
                  <form method="post" action="{% url 'approve_user' pending_user.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-success">Approve</button>
                  </form>
                  <form method="post" action="{% url 'reject_user' pending_user.id %}" style="display:inline;" class="ms-2">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger">Reject</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% else %}
    <div class="alert alert-info" role="alert">
      No pending registration requests at this time.
    </div>
    {% endif %}

    <div class="card mb-3 mt-4">
      <div class="card-header">
        <h5 class="mb-0">Pending Orders{% if pending_orders %} ({{ pending_orders|length }}){% endif %}</h5>
      </div>
      <div class="card-body">
        {% if pending_orders %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Type</th>
                <th>Placed At</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for order in pending_orders %}
              <tr>
                <td>#{{ order.id }}</td>
                <td>
                  {% if order.customer and order.customer.login %}
                    <a href="{% url 'profile' order.customer.login.id %}">{{ order.customer.login.username }}</a>
                  {% else %}
                    <span class="text-muted">Unknown</span>
                  {% endif %}
                </td>
                <td>{{ order.get_order_type_display|default:order.order_type }}</td>
                <td><small>{{ order.date|localtime }}</small></td>
                <td>
                  <a href="{% url 'assign_order' order.id %}" class="btn btn-sm btn-outline-primary">
                    Review Bids / Assign
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-info mb-0" role="alert">
          There are currently no pending orders.
        </div>
        {% endif %}
      </div>
    </div>

    <div class="card mb-3 mt-4">
      <div class="card-header">
        <h5 class="mb-0">Suspension Pleas{% if pleas %} ({{ pleas|length }}){% endif %}</h5>
      </div>
      <div class="card-body">
        {% if pleas %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>User</th>
                <th>Submitted</th>
                <th>Message</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for plea in pleas %}
              <tr>
                <td><strong>{{ plea.sender.username }}</strong></td>
                <td><small>{{ plea.created_at|date:"M d, Y H:i" }}</small></td>
                <td style="max-width: 320px; white-space: pre-wrap;">{{ plea.text }}</td>
                <td>
                  <form method="post" action="{% url 'plea_forgive' plea.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-success mb-1">Forgive &amp; Reactivate</button>
                  </form>
                  <form method="post" action="{% url 'plea_kick' plea.id %}" style="display:inline;" class="ms-1">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger">Kick Out</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-info mb-0" role="alert">
          There are currently no suspension pleas from customers.
        </div>
        {% endif %}
      </div>
    </div>

    <div class="card mb-3 mt-4">
      <div class="card-header">
        <h5 class="mb-0">Pending Complaints{% if pending_complaints %} ({{ pending_complaints|length }}){% endif %}</h5>
      </div>
      <div class="card-body">
        {% if pending_complaints %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Filed By</th>
                <th>About</th>
                <th>Message</th>
                <th>Filed At</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for complaint in pending_complaints %}
              <tr>
                <td>
                  {% if complaint.sender %}
                    <strong>{{ complaint.sender.username }}</strong>
                  {% else %}
                    <span class="text-muted">Unknown</span>
                  {% endif %}
                </td>
                <td>
                  {% if complaint.to %}
                    <strong>{{ complaint.to.username }}</strong>
                  {% else %}
                    <span class="text-muted">Unknown</span>
                  {% endif %}
                </td>
                <td style="max-width: 320px; white-space: pre-wrap;">
                  {{ complaint.message.message }}
                </td>
                <td>
                  {% if complaint.message.when %}
                    <small>{{ complaint.message.when|localtime }}</small>
                  {% else %}
                    <span class="text-muted">N/A</span>
                  {% endif %}
                </td>
                <td>
                  <form method="post" action="{% url 'review_complaint' complaint.id %}" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="decision" value="accept" />
                    <button type="submit" class="btn btn-sm btn-success mb-1">Accept as Valid</button>
                  </form>
                  <form method="post" action="{% url 'review_complaint' complaint.id %}" style="display:inline;" class="ms-1">
                    {% csrf_token %}
                    <input type="hidden" name="decision" value="reject" />
                    <button type="submit" class="btn btn-sm btn-outline-danger">Reject</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-info mb-0" role="alert">
          There are currently no pending complaints.
        </div>
        {% endif %}
      </div>
    </div>

    <div class="card mb-3 mt-4">
      <div class="card-header">
        <h5 class="mb-0">Reported FAQ Entries{% if reported_faqs %} ({{ reported_faqs|length }}){% endif %}</h5>
      </div>
      <div class="card-body">
        {% if reported_faqs %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Question</th>
                <th>Reported By</th>
                <th>Reported At</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for report in reported_faqs %}
              <tr>
                <td style="max-width: 400px; white-space: pre-wrap;">{{ report.faq_entry.question }}</td>
                <td>{{ report.reported_by.username }}</td>
                <td><small>{{ report.reported_at|date:"M d, Y H:i" }}</small></td>
                <td>
                  <form method="post" action="{% url 'keep_faq' report.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-success mb-1">Keep</button>
                  </form>
                  <form method="post" action="{% url 'delete_faq' report.id %}" style="display:inline;" class="ms-1">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-info mb-0" role="alert">
          There are currently no reported FAQ entries.
        </div>
        {% endif %}
      </div>
    </div>

  </div>

  <div class="col-md-4">
    {% if user.is_authenticated and user.id == target.id %}
      <div class="card mb-3">
        <div class="card-header">Your Manager Tools</div>
        <div class="card-body d-grid gap-2">
          <a class="btn btn-primary" href="{% url 'manage_menu' %}">Manage Menu</a>
          <a class="btn btn-outline-primary" href="{% url 'manage_users' %}">Manage Users</a>
          <a class="btn btn-outline-primary" href="{% url 'discussions' %}">Team Discussions</a>
          <a class="btn btn-outline-secondary" href="{% url 'index' %}">Back to Home</a>
        </div>
      </div>
    {% endif %}
  </div>
</div>

{% endblock %}
