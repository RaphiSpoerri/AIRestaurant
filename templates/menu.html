{% extends 'restaurant/base.html' %}
{% load static %}

{% block extra_head %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}

{% block title %}Our Menu - AI Restaurant{% endblock %}

{% block extra_css %}
<style>
    .dish-card {
        transition: transform 0.3s;
        margin-bottom: 20px;
    }
    .dish-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .dish-img {
        height: 200px;
        object-fit: cover;
    }
    .quantity-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 10px;
    }
    .quantity-btn {
        width: 30px;
        height: 30px;
        border: 1px solid #ddd;
        background: #f8f9fa;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    .quantity-input {
        width: 50px;
        text-align: center;
        margin: 0 10px;
    }
    .checkout-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
        padding: 15px 30px;
        font-size: 1.2rem;
        font-weight: bold;
        border-radius: 50px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .rating-stars {
        color: #ffc107;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="text-center my-5">Our Delicious Menu</h1>
    
    <div class="row">
        {% for dish in dishes %}
        <div class="col-md-4 col-sm-6 mb-4">
            <div class="card dish-card h-100">
                {% if dish.image %}
                <img src="{{ dish.image.url }}" class="card-img-top dish-img" alt="{{ dish.name }}">
                {% else %}
                <div class="dish-img bg-light d-flex align-items-center justify-content-center">
                    <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                </div>
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">{{ dish.name }}</h5>
                    <p class="card-text">{{ dish.description }}</p>
                    <p class="h5 text-primary">${{ dish.price }}</p>
                    
                    <!-- Dish Rating -->
                    <div class="rating-stars">
                        {% for i in "12345"|make_list %}
                            {% if forloop.counter <= dish.average_rating %}
                                <i class="bi bi-star-fill"></i>
                            {% else %}
                                <i class="bi bi-star"></i>
                            {% endif %}
                        {% endfor %}
                        <small class="text-muted">({{ dish.rating_count }} ratings)</small>
                    </div>
                    
                    <!-- Quantity Controls (only for logged-in customers) -->
                    {% if user.is_authenticated and user.is_customer %}
                    <div class="quantity-controls">
                        <button class="quantity-btn minus" data-dish-id="{{ dish.id }}">-</button>
                        <input type="number" class="form-control quantity-input" id="quantity-{{ dish.id }}" value="0" min="0" readonly>
                        <button class="quantity-btn plus" data-dish-id="{{ dish.id }}">+</button>
                    </div>
                    {% endif %}
                    
                    <!-- Rate This Dish (only for logged-in customers who have ordered this dish) -->
                    {% if user.is_authenticated and user.is_customer and dish.can_rate %}
                    <div class="mt-2">
                        <small>Rate this dish:</small>
                        <div class="rating-input" data-dish-id="{{ dish.id }}">
                            {% for i in "12345"|make_list %}
                                <i class="bi bi-star star" data-rating="{{ forloop.counter }}"></i>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Checkout Button (only for customers with items in cart) -->
{% if user.is_authenticated and user.is_customer %}
<button id="checkoutBtn" class="btn btn-primary checkout-btn d-none">
    <i class="bi bi-cart-check"></i> CHECKOUT
</button>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Handle quantity changes
    $('.quantity-btn').click(function() {
        const dishId = $(this).data('dish-id');
        const $input = $(`#quantity-${dishId}`);
        let value = parseInt($input.val());
        
        if ($(this).hasClass('plus')) {
            $input.val(value + 1);
        } else if ($(this).hasClass('minus') && value > 0) {
            $input.val(value - 1);
        }
        
        updateCart();
    });
    
        // Get CSRF token for AJAX requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Handle star rating
    $('.star').click(function() {
        const dishId = $(this).parent().data('dish-id');
        const rating = $(this).data('rating');
        
        // Show loading state
        const $stars = $(this).parent().find('.star');
        $stars.removeClass('bi-star-fill').addClass('bi-star');
        $(this).prevAll('.star').addBack().addClass('bi-star-fill').removeClass('bi-star');
        
        // Send AJAX request to save rating
        $.ajax({
            url: `{% url 'rate_dish' 0 %}`.replace('0', dishId),
            method: 'POST',
            data: {
                rating: rating,
                csrfmiddlewaretoken: csrftoken
            },
            success: function(response) {
                // Show success message
                const $alert = $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                    '<span>Thank you for your rating!</span>' +
                    '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                '</div>');
                $('body').prepend($alert);
                
                // Remove alert after 3 seconds
                setTimeout(() => {
                    $alert.alert('close');
                }, 3000);
                
                // Update the rating display
                location.reload(); // Simple refresh for now
            },
            error: function(xhr) {
                // Show error message
                const errorMsg = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Failed to save rating. Please try again.';
                const $alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                    '<span>' + errorMsg + '</span>' +
                    '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                '</div>');
                $('body').prepend($alert);
                
                // Remove alert after 5 seconds
                setTimeout(() => {
                    $alert.alert('close');
                }, 5000);
                
                // Reset stars
                $stars.removeClass('bi-star-fill').addClass('bi-star');
            }
        });
    });
    
    // Update cart and show/hide checkout button
    function updateCart() {
        const cart = {};
        $('.quantity-input').each(function() {
            const dishId = $(this).attr('id').replace('quantity-', '');
            const quantity = parseInt($(this).val());
            if (quantity > 0) {
                cart[dishId] = quantity;
            }
        });
        
        // Save cart to session/local storage
        localStorage.setItem('cart', JSON.stringify(cart));
        
        // Show/hide checkout button
        if (Object.keys(cart).length > 0) {
            $('#checkoutBtn').removeClass('d-none');
        } else {
            $('#checkoutBtn').addClass('d-none');
        }
    }
    
    // Initialize cart from storage
    const savedCart = localStorage.getItem('cart');
    if (savedCart) {
        const cart = JSON.parse(savedCart);
        for (const [dishId, quantity] of Object.entries(cart)) {
            $(`#quantity-${dishId}`).val(quantity);
        }
        updateCart();
    }
    
    // Handle checkout button click
    $('#checkoutBtn').click(function() {
        const $btn = $(this);
        const cart = JSON.parse(localStorage.getItem('cart') || '{}');
        
        // Disable button and show loading state
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...');
        
        // Save cart to server and redirect to checkout
        $.ajax({
            url: '{% url "update_cart" %}',
            method: 'POST',
            data: {
                cart: JSON.stringify(cart),
                csrfmiddlewaretoken: csrftoken
            },
            success: function() {
                window.location.href = "{% url 'cart' %}";
            },
            error: function(xhr) {
                // Re-enable button
                $btn.prop('disabled', false).html('<i class="bi bi-cart-check"></i> CHECKOUT');
                
                // Show error message
                const errorMsg = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Failed to update cart. Please try again.';
                const $alert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert">' +
                    '<span>' + errorMsg + '</span>' +
                    '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                '</div>');
                $('body').prepend($alert);
                
                // Remove alert after 5 seconds
                setTimeout(() => {
                    $alert.alert('close');
                }, 5000);
            }
        });
    });
});
</script>
{% endblock %}
