{% extends "base.html" %}
{% load filters %}
{% block title %}Manage Users - AI Restaurant{% endblock %}

{% block content %}
<div class="container my-4">
  <h1 class="mb-4">User Management</h1>

  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">All Users</h5>
    </div>
    <div class="card-body">
      {% if user_rows %}
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle table-sm" style="font-size: 0.9rem;">
          <thead class="table-light">
            <tr>
              <th style="width: 4rem;">ID</th>
              <th style="width: 9rem;">Username</th>
              <th style="width: 14rem;">Email</th>
              <th>Type</th>
              <th>Status</th>
              <th>Profile Info</th>
              <th>Employee Info</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for row in user_rows %}
            {% with u=row.user extra=row.extra %}
            <tr>
              <td>{{ u.id }}</td>
              <td><a href="{% url 'profile' u.id %}">{{ u.username }}</a></td>
              <td>{{ u.email }}</td>
              <td>
                {% if u.type == 'CU' %}Customer
                {% elif u.type == 'CH' %}Chef
                {% elif u.type == 'DL' %}Deliverer
                {% elif u.type == 'MN' %}Manager
                {% else %}{{ u.type }}{% endif %}
              </td>
              <td>
                <form method="post" action="{% url 'manage_users' %}" class="d-flex align-items-center gap-1">
                  {% csrf_token %}
                  <input type="hidden" name="user_id" value="{{ u.id }}">
                  <select name="status" class="form-select form-select-sm" style="min-width: 40px;">
                    <option value="AC" {% if u.status == 'AC' %}selected{% endif %}>Active</option>
                    <option value="PN" {% if u.status == 'PN' %}selected{% endif %}>Pending</option>
                    <option value="SU" {% if u.status == 'SU' %}selected{% endif %}>Suspended</option>
                  </select>
                  {% if u.type == 'CU' and row.profile %}
                    <input type="number" name="warnings" min="0" class="form-control form-control-sm" style="min-width: 40px;" value="{{ row.profile.warnings }}" placeholder="Warnings">
                    <div class="form-check form-check-sm ms-1">
                      <input class="form-check-input" type="checkbox" name="vip" id="vip-{{ u.id }}" {% if row.profile.vip %}checked{% endif %}>
                      <label class="form-check-label" for="vip-{{ u.id }}">VIP</label>
                    </div>
                  {% endif %}
                  {% if u.type == 'CH' or u.type == 'DL' or u.type == 'MN' and row.profile %}
                    <input type="number" name="salary" min="0" step="0.01" class="form-control form-control-sm" style="max-width: 6rem;" value="{{ row.extra.employee_salary_dollars }}" style="min-width: 50px;" placeholder="Salary ($)">
                  {% endif %}
                  <button type="submit" class="btn btn-sm btn-outline-success">Save</button>
                </form>
              </td>
              <td style="max-width: 260px; white-space: pre-wrap;">
                {% if u.type == 'CU' %}
                  {% if row.profile %}
                    Balance: {{ row.profile.balance|format_cents_as_money }}\n
                    Warnings: {{ row.profile.warnings }}\n
                    VIP: {{ row.profile.vip|yesno:"Yes,No" }}
                  {% else %}
                    <span class="text-muted">No customer profile</span>
                  {% endif %}
                {% elif u.type == 'CH' %}
                  {% if row.profile %}
                    Chef profile attached
                  {% else %}
                    <span class="text-muted">No chef profile</span>
                  {% endif %}
                {% elif u.type == 'DL' %}
                  {% if row.profile %}
                    Deliverer profile attached
                  {% else %}
                    <span class="text-muted">No deliverer profile</span>
                  {% endif %}
                {% elif u.type == 'MN' %}
                  {% if row.profile %}
                    Manager profile attached
                  {% else %}
                    <span class="text-muted">No manager profile</span>
                  {% endif %}
                {% endif %}
              </td>
              <td style="max-width: 260px; white-space: pre-wrap;">
                {% if extra.employee_status %}
                  Status: {{ extra.employee_status }}\n
                  Salary: ${{ extra.employee_salary_dollars|floatformat:2 }} / hr\n
                  {% if extra.employee_score is not None %}
                    Reputation Score: {{ extra.employee_score }}
                  {% endif %}
                {% else %}
                  <span class="text-muted">N/A</span>
                {% endif %}
              </td>
              <td>
                <a class="btn btn-sm btn-outline-primary" href="{% url 'profile' u.id %}">View Profile</a>
              </td>
            </tr>
            {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-info mb-0" role="alert">
        No users found.
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
